# MASTRAãƒ¡ãƒ¢ãƒªæ©Ÿèƒ½ - å…·ä½“çš„ä½¿ç”¨ä¾‹ã¨åŠ¹æœ

## ğŸ¯ 1. å€‹äººåŒ–ã•ã‚ŒãŸãƒˆãƒ¬ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚µãƒãƒ¼ãƒˆ

### å¾“æ¥ï¼ˆãƒ¡ãƒ¢ãƒªãªã—ï¼‰
```typescript
// æ¯å›åŒã˜æ±ç”¨çš„ãªåˆ†æ
ãƒ¦ãƒ¼ã‚¶ãƒ¼: "BTCã®åˆ†æã‚’ãŠé¡˜ã„ã—ã¾ã™"
AI: "BTC/USDTã‚’åˆ†æã—ã¾ã™ã€‚ç¾åœ¨ä¾¡æ ¼ã¯$45,000ã§ã™..."
```

### ãƒ¡ãƒ¢ãƒªæ©Ÿèƒ½å¾Œ
```typescript
// å€‹äººã®å–å¼•å±¥æ­´ã¨å¥½ã¿ã‚’è€ƒæ…®ã—ãŸåˆ†æ
ãƒ¦ãƒ¼ã‚¶ãƒ¼: "BTCã®åˆ†æã‚’ãŠé¡˜ã„ã—ã¾ã™"
AI: "å‰å›ã®$42,000ã§ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ï¼ˆ+3.2%æˆåŠŸï¼‰ã‚’å‚è€ƒã«ã€
     ã‚ãªãŸã®å¥½ã‚€4æ™‚é–“è¶³ã§åˆ†æã—ã¾ã™ã€‚RSIãŒ28ã¨éå£²ã‚Šåœã§ã€
     ã‚ãªãŸã®å¾—æ„ãªæŠ¼ã—ç›®è²·ã„ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒå‡ºç¾ã—ã¦ã„ã¾ã™ã€‚"
```

### å®Ÿè£…ã‚³ãƒ¼ãƒ‰ä¾‹
```typescript
// src/mastra/agents/tradingAgent.ts
const memory = new Memory({
  storage: new SupabaseVectorStorage({
    lastMessages: 40,
    semanticRecall: {
      topK: 5,        // é¡ä¼¼çŠ¶æ³ä¸Šä½5ä»¶ã‚’å–å¾—
      messageRange: 2, // å‰å¾Œ2ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å«ã‚ã‚‹
    },
  }),
});

export const tradingAgent = new Agent({
  name: "ãƒˆãƒ¬ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼",
  memory: memory, // ğŸ”¥ ãƒ¡ãƒ¢ãƒªæ©Ÿèƒ½ãŒæœ‰åŠ¹
  tools: { chartAnalysisTool, marketDataTool },
  instructions: `
    éå»ã®ä¼šè©±å±¥æ­´ã‚’å‚è€ƒã«ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å–å¼•ã‚¹ã‚¿ã‚¤ãƒ«ã«
    åˆã‚ã›ãŸå€‹åˆ¥åŒ–ã•ã‚ŒãŸã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚
  `
});
```

## ğŸ“š 2. å­¦ç¿’å‹åˆ†æã®ç¶™ç¶šæ€§

### ã‚·ãƒŠãƒªã‚ª: 2é€±é–“é€£ç¶šã®BTCåˆ†æ

**1æ—¥ç›®**: 
```
ãƒ¦ãƒ¼ã‚¶ãƒ¼: "BTCã®çŠ¶æ³ã¯ã©ã†ã§ã™ã‹ï¼Ÿ"
AI: "$42,000ã®ã‚µãƒãƒ¼ãƒˆãƒ¬ãƒ™ãƒ«ã‚’ç¢ºèªã€‚RSI30ã§éå£²ã‚ŠçŠ¶æ…‹ã§ã™ã€‚"
ãƒ¡ãƒ¢ãƒªä¿å­˜: [åˆ†ææ—¥æ™‚, ä¾¡æ ¼ãƒ¬ãƒ™ãƒ«, æŒ‡æ¨™çŠ¶æ³, æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³]
```

**3æ—¥ç›®**:
```
ãƒ¦ãƒ¼ã‚¶ãƒ¼: "å‰å›ã®åˆ†æå¾Œã€ã©ã†å¤‰åŒ–ã—ã¾ã—ãŸã‹ï¼Ÿ"
AI: "2æ—¥å‰ã®$42,000ã‚µãƒãƒ¼ãƒˆåˆ†æã§ã¯ä¸Šæ˜‡ã‚’äºˆæ¸¬ã—ã¾ã—ãŸã€‚
     ç¾åœ¨$43,500ã¾ã§ä¸Šæ˜‡ï¼ˆ+3.6%ï¼‰ã—ã¦ã„ã¾ã™ã€‚
     äºˆæ¸¬ãŒçš„ä¸­ã—ãŸãŸã‚ã€åˆ©ç¢ºã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’æ¤œè¨ã—ã¾ã—ã‚‡ã†ã€‚"
```

**2é€±é–“å¾Œ**:
```
ãƒ¦ãƒ¼ã‚¶ãƒ¼: "ã¾ãŸåˆ†æã‚’ãŠé¡˜ã„ã—ã¾ã™"
AI: "2é€±é–“å‰ã®ã‚µã‚¤ã‚¯ãƒ«ã‚’å‚è€ƒã«ã—ã¾ã™ã€‚
     å‰å›ï¼š$42,000â†’$44,000ï¼ˆ+4.8%æˆåŠŸï¼‰
     ç¾åœ¨ï¼š$41,800ï¼ˆé¡ä¼¼ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
     ã‚ãªãŸã®æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³ãŒå†ç¾ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚"
```

### ãƒ¡ãƒ¢ãƒªæ´»ç”¨ã‚³ãƒ¼ãƒ‰
```typescript
// éå»ã®é¡ä¼¼çŠ¶æ³ã‚’æ¤œç´¢
const similarAnalysis = await storage.semanticSearch(
  queryEmbedding, 
  {
    topK: 3,
    threshold: 0.8,
    threadId: 'btc_analysis',
    resourceId: userId
  }
);

// æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å­¦ç¿’
const successfulTrades = messages.filter(msg => 
  msg.metadata?.result === 'successful' && 
  msg.metadata?.profitLoss > 0
);
```

## ğŸ§µ 3. è¤‡æ•°ãƒ†ãƒ¼ãƒä¸¦è¡Œç®¡ç†

### å®Ÿéš›ã®ä½¿ç”¨ä¾‹
```typescript
const threads = {
  'btc_daily_analysis': 'æ—¥æ¬¡BTCåˆ†æã‚¹ãƒ¬ãƒƒãƒ‰',
  'eth_swing_trading': 'ETHã‚¹ã‚¤ãƒ³ã‚°ãƒˆãƒ¬ãƒ¼ãƒ‰æˆ¦ç•¥',
  'portfolio_review': 'ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªãƒ¬ãƒ“ãƒ¥ãƒ¼',
  'market_sentiment': 'å¸‚å ´ã‚»ãƒ³ãƒãƒ¡ãƒ³ãƒˆåˆ†æ',
  'risk_management': 'ãƒªã‚¹ã‚¯ç®¡ç†ç›¸è«‡'
};

// å„ã‚¹ãƒ¬ãƒƒãƒ‰ã§ç‹¬ç«‹ã—ãŸæ–‡è„ˆã‚’ä¿æŒ
await storage.saveMessage({
  threadId: 'btc_daily_analysis',
  content: "BTCæ—¥æ¬¡åˆ†æï¼šã‚µãƒãƒ¼ãƒˆ$42,000ç¢ºèª",
  metadata: { analysis_type: 'daily', symbol: 'BTCUSDT' }
});

await storage.saveMessage({
  threadId: 'eth_swing_trading', 
  content: "ETHã‚¹ã‚¤ãƒ³ã‚°ï¼š1é€±é–“ãƒ›ãƒ¼ãƒ«ãƒ‰æˆ¦ç•¥å®Ÿè¡Œä¸­",
  metadata: { strategy: 'swing', timeframe: '1w' }
});
```

## ğŸ“ 4. å­¦ç¿’å‹æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³èªè­˜

### å®Ÿè£…ä¾‹
```typescript
class TradingPatternLearner {
  async analyzeSuccessPatterns(userId: string) {
    const successfulTrades = await storage.getMessages(
      undefined, userId, 100
    ).then(messages => 
      messages.filter(m => m.metadata?.result === 'successful')
    );

    const patterns = {
      priceRanges: this.extractPricePatterns(successfulTrades),
      indicators: this.extractIndicatorPatterns(successfulTrades),
      timeframes: this.extractTimeframePatterns(successfulTrades),
      entrySignals: this.extractEntrySignals(successfulTrades)
    };

    return {
      successRate: this.calculateSuccessRate(patterns),
      recommendations: this.generateRecommendations(patterns)
    };
  }

  generatePersonalizedAdvice(currentMarket: any, patterns: any) {
    return `
      ã‚ãªãŸã®æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æ:
      â€¢ ${patterns.priceRanges.best}ä»˜è¿‘ã§ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼æˆåŠŸç‡: 78%
      â€¢ ${patterns.indicators.favorite}ã§ã®å‹ç‡: 82%
      â€¢ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: ${this.matchPattern(currentMarket, patterns)}
    `;
  }
}
```

## ğŸ” 5. ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯æ¤œç´¢ã®å¨åŠ›

### è‡ªç„¶è¨€èªã«ã‚ˆã‚‹éå»åˆ†ææ¤œç´¢
```typescript
// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•
const query = "å‰å›ã®ã‚ˆã†ãªæš´è½æ™‚ã¯ã©ã†å¯¾å¿œã—ã¾ã—ãŸã‹ï¼Ÿ";

// è‡ªå‹•çš„ã«é–¢é€£ã™ã‚‹éå»ã®çŠ¶æ³ã‚’æ¤œç´¢
const relatedMemories = await semanticSearch(
  await embedQuery(query),
  { 
    topK: 5,
    threshold: 0.75 
  }
);

// çµæœä¾‹:
// 1. "2024-01-10: BTC 15%æš´è½æ™‚â†’æ®µéšçš„è²·ã„ä¸‹ãŒã‚Šæˆ¦ç•¥â†’+8%æˆåŠŸ"
// 2. "2024-01-15: ETHæ€¥è½å¯¾å¿œâ†’ã‚¹ãƒˆãƒƒãƒ—ãƒ­ã‚¹ç™ºå‹•â†’-2%æåˆ‡ã‚ŠæˆåŠŸ"  
// 3. "2024-01-20: å¸‚å ´å…¨ä½“æš´è½â†’ç¾é‡‘æ¯”ç‡50%â†’ãƒªã‚¹ã‚¯å›é¿æˆåŠŸ"
```

## ğŸ† 6. å®Ÿéš›ã®æˆæœä¾‹

### Beforeï¼ˆãƒ¡ãƒ¢ãƒªãªã—ï¼‰
- æ¯å›åŒã˜æ±ç”¨åˆ†æ
- éå»ã®æˆåŠŸãƒ»å¤±æ•—ã‚’è€ƒæ…®ã§ããªã„
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¥½ã¿ã‚’å­¦ç¿’ã§ããªã„
- æˆ¦ç•¥ã®ä¸€è²«æ€§ãªã—

### Afterï¼ˆãƒ¡ãƒ¢ãƒªã‚ã‚Šï¼‰
- å€‹äººã®å–å¼•å±¥æ­´ã‚’è€ƒæ…®ã—ãŸåˆ†æ
- æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³ã®å­¦ç¿’ã¨æ´»ç”¨
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ«ã«åˆã‚ã›ãŸæ¨å¥¨
- é•·æœŸçš„ãªæˆ¦ç•¥ã®ä¸€è²«æ€§

### å…·ä½“çš„ãªæ”¹å–„æ•°å€¤ï¼ˆæƒ³å®šï¼‰
```
åˆ†æã®å€‹äººåŒ–åº¦: 0% â†’ 85%
æ¨å¥¨ã®ç²¾åº¦å‘ä¸Š: +45%
ãƒ¦ãƒ¼ã‚¶ãƒ¼æº€è¶³åº¦: +60%
ç¶™ç¶šåˆ©ç”¨ç‡: +70%
```

## ğŸš€ 7. ä»Šã™ãè©¦ã›ã‚‹æ´»ç”¨æ–¹æ³•

### Step 1: Supabaseã‚¹ã‚­ãƒ¼ãƒé©ç”¨
```bash
# database/mastra-schema.sqlã‚’å®Ÿè¡Œ
psql -h your-db-host -U postgres -d postgres -f database/mastra-schema.sql
```

### Step 2: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ãƒ¡ãƒ¢ãƒªæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
```bash
# ãƒ¡ãƒ¢ãƒªä»˜ãã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ãƒ†ã‚¹ãƒˆ
npm test -- src/tests/mastra/agents/tradingAgent.test.ts
```

### Step 3: ãƒãƒ£ãƒƒãƒˆã§ãƒ¡ãƒ¢ãƒªåŠ¹æœå®Ÿæ„Ÿ
```bash
# UIã§ãƒ¡ãƒ¢ãƒªæ©Ÿèƒ½ã‚’ä½“é¨“
npm run dev
# http://localhost:3000 ã§ãƒãƒ£ãƒƒãƒˆé–‹å§‹
# åŒã˜è³ªå•ã‚’ç¹°ã‚Šè¿”ã—ã¦å­¦ç¿’åŠ¹æœã‚’ç¢ºèª
```

## ğŸ¯ 8. ãƒ¡ãƒ¢ãƒªæ©Ÿèƒ½ã®ç©¶æ¥µç›®æ¨™

**ã€Œã‚ãªãŸå°‚ç”¨ã®AIãƒˆãƒ¬ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã€**

- ã‚ãªãŸã®å–å¼•ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å®Œå…¨ã«ç†è§£
- æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å­¦ç¿’ã—ã¦å†ç¾
- å¤±æ•—ã‚’å­¦ç¿’ã—ã¦ãƒªã‚¹ã‚¯å›é¿
- é•·æœŸçš„ãªè³‡ç”£æˆé•·ã‚’ã‚µãƒãƒ¼ãƒˆ

ã“ã‚Œã§**å˜ãªã‚‹AIãƒ„ãƒ¼ãƒ«**ã‹ã‚‰**å­¦ç¿’å‹AIãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼**ã«é€²åŒ–ï¼

---

*MASTRAãƒ¡ãƒ¢ãƒªæ©Ÿèƒ½ã«ã‚ˆã‚Šã€çœŸã®ã€ŒAIå­¦ç¿’å‹ãƒˆãƒ¬ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã€ãŒå®Ÿç¾ã•ã‚Œã¾ã—ãŸã€‚* 