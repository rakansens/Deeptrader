# DeepTrader アーキテクチャ設計

## 1. システム概要

DeepTraderは、AIを活用した暗号資産トレーディングアシスタントで、自然言語インターフェースによりトレーダーの意思決定をサポートします。システムはドメイン駆動設計（DDD）の原則に基づいて設計され、テスト駆動開発（TDD）の方法論で実装されます。

## 2. アーキテクチャの全体像

DeepTraderはクライアントサーバーアーキテクチャを採用し、フロントエンドとバックエンドが明確に分離されています。

```
+----------------------------+        +----------------------------+
|                            |        |                            |
|        フロントエンド       |<------>|         バックエンド        |
|        (Next.js)           |        |        (Supabase)          |
|                            |        |                            |
+----------------------------+        +----------------------------+
           |                                         |
           v                                         v
+----------------------------+        +----------------------------+
|                            |        |                            |
|     AI エージェント層       |<------>|       データストレージ層    |
|      (Mastra)              |        |        (Supabase)          |
|                            |        |                            |
+----------------------------+        +----------------------------+
           |
           v
+----------------------------+
|                            |
|     外部サービス連携層      |
|   (取引所API, 外部データ)   |
|                            |
+----------------------------+
```

## 3. ディレクトリ構造

プロジェクトはNext.jsを使用しており、以下のディレクトリ構造を採用します：

```
/src                          # ソースコードのルートディレクトリ
  /app                        # Next.js App Router
    /api                      # APIルート
    /(routes)                 # 各ページのルート
    layout.tsx                # レイアウト定義
    page.tsx                  # トップページ
  /components                 # UIコンポーネント
    /ui                       # 汎用UIコンポーネント
    /charts                   # チャート関連コンポーネント
    /trading                  # トレード関連コンポーネント
    /chat                     # チャットインターフェースコンポーネント
  /hooks                      # カスタムReactフック
  /lib                        # ユーティリティ関数
  /styles                     # グローバルスタイル
  /mastra                     # Mastra AIエージェント関連
    /agents                   # AIエージェント定義
    /tools                    # ツール定義
    /workflows                # ワークフロー定義
    /memory                   # メモリ設定
    /mcp                      # MCPサーバー/クライアント設定
    index.ts                  # Mastraエクスポート
  /domain                     # ドメイン駆動設計の実装
    /trading                  # トレーディングドメイン
    /market                   # 市場データドメイン
    /user                     # ユーザードメイン
  /infrastructure             # 外部サービス連携
    /api                      # API接続
    /supabase                 # Supabase連携
    /exchange                 # 取引所連携
  /types                      # TypeScript型定義
  /tests                      # テストファイル
/public                       # 静的ファイル
/docs                         # ドキュメント
.env.local                    # 環境変数（ローカル）
.env.example                  # 環境変数サンプル
```

### 現在の構造と移行について

現在、プロジェクトはNext.jsの従来の構造を使っていますが、より良い構造化のために`/src`ディレクトリを導入することを推奨します。移行手順：

1. プロジェクトルートに`src`ディレクトリを作成
2. 既存の`app`、`components`、`hooks`、`lib`ディレクトリを`src`内に移動
3. `tsconfig.json`のパス設定を更新
4. 新たなドメイン層とインフラ層のディレクトリを作成

この構造はドメイン駆動設計の原則に基づいており、関心の分離を実現しています。また、テスト駆動開発を容易にするため、各機能モジュールと対応するテストが明確に整理されています。

## 4. コンポーネント詳細

### 4.1 フロントエンド層

フロントエンド層はNext.jsを使用して実装され、以下のコンポーネントで構成されます：

- **UIコンポーネント**: 共通のユーザーインターフェース要素
- **チャートコンポーネント**: LightWeight Chartsを使用した取引チャート
- **チャットインターフェース**: 自然言語による対話インターフェース

### 4.2 バックエンド層

バックエンド層はSupabaseを使用して実装され、以下のコンポーネントで構成されます：

- **認証サービス**: ユーザー認証と認可
- **データベース**: ユーザー設定、取引履歴、分析結果の保存
- **リアルタイムサービス**: WebSocketを介したリアルタイム更新

### 4.3 AIエージェント層

AIエージェント層はMastraフレームワークを使用して実装され、以下のコンポーネントで構成されます：

- **トレーディングエージェント**: 市場分析と取引戦略の提案
- **リサーチエージェント**: 市場情報と関連データの収集・分析
- **UIコントロールエージェント**: UIの操作と制御

## 5. データフロー

```
[ユーザー] → [自然言語入力] → [AIエージェント] → [ツール実行] → [データ取得/分析] → [レスポンス生成] → [UIレンダリング] → [ユーザー]
```

ユーザーが自然言語でリクエストを行うと、AIエージェントがその意図を理解し、適切なツールを使用してデータを取得・分析します。分析結果はユーザーにわかりやすい形で提示され、必要に応じてチャートや視覚的要素も含まれます。

## 6. セキュリティ考慮事項

- **API認証**: すべての外部APIリクエストは適切な認証を使用
- **データ暗号化**: 機密データは保存時と転送時に暗号化
- **アクセス制御**: ロールベースのアクセス制御システム
- **入力検証**: すべてのユーザー入力は検証とサニタイズを実施

## 7. スケーラビリティ戦略

- **マイクロサービスアーキテクチャ**: 高負荷コンポーネントの分離
- **ステートレス設計**: 水平スケーリングを容易にする
- **キャッシング戦略**: 頻繁にアクセスされるデータのキャッシング
- **効率的なデータ取得**: 必要なデータのみを取得するクエリ最適化

## 8. テスト戦略

TDD原則に従い、以下のテストレベルを実装します：

- **単体テスト**: 個々のコンポーネントとドメインロジックのテスト
- **統合テスト**: コンポーネント間の相互作用のテスト
- **E2Eテスト**: ユーザーフローと全体的な機能のテスト
- **パフォーマンステスト**: 応答時間と処理能力のテスト
